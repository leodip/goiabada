{{define "title"}}{{ .appName }} - Settings - General{{end}}
{{define "pageTitle"}}Settings{{end}}
{{define "subTitle"}}
    <div class="text-xl font-semibold">Settings - General</div>
    <div class="mt-2 divider"></div> 
{{end}}
{{define "menu"}}
    {{template "admin_menu" . }}
{{end}}

{{define "head"}}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selfRegistrationEnabled = document.getElementById('selfRegistrationEnabled');
        const selfRegistrationRequiresEmailVerification = document.getElementById('selfRegistrationRequiresEmailVerification');
        const originalIssuerValue = "{{.settings.Issuer}}";

        selfRegistrationEnabled.addEventListener('change', function () {
            refreshSelfRegistrationEmailVerification();
        });
        refreshSelfRegistrationEmailVerification();

        // PKCE warning handling
        const pkceRequired = document.getElementById('pkceRequired');
        const pkceWarning = document.getElementById('pkceWarning');

        function updatePkceWarning() {
            if (pkceRequired && pkceWarning) {
                if (!pkceRequired.checked) {
                    pkceWarning.classList.remove('hidden');
                } else {
                    pkceWarning.classList.add('hidden');
                }
            }
        }

        if (pkceRequired) {
            pkceRequired.addEventListener('change', updatePkceWarning);
            updatePkceWarning(); // Initial state
        }

        // Implicit flow warning handling
        const implicitFlowEnabled = document.getElementById('implicitFlowEnabled');
        const implicitFlowWarning = document.getElementById('implicitFlowWarning');

        function updateImplicitFlowWarning() {
            if (implicitFlowEnabled && implicitFlowWarning) {
                if (implicitFlowEnabled.checked) {
                    implicitFlowWarning.classList.remove('hidden');
                } else {
                    implicitFlowWarning.classList.add('hidden');
                }
            }
        }

        if (implicitFlowEnabled) {
            implicitFlowEnabled.addEventListener('change', updateImplicitFlowWarning);
            updateImplicitFlowWarning(); // Initial state
        }

        // ROPC flow warning handling
        const ropcFlowEnabled = document.getElementById('ropcFlowEnabled');
        const ropcFlowWarning = document.getElementById('ropcFlowWarning');

        function updateRopcFlowWarning() {
            if (ropcFlowEnabled && ropcFlowWarning) {
                if (ropcFlowEnabled.checked) {
                    ropcFlowWarning.classList.remove('hidden');
                } else {
                    ropcFlowWarning.classList.add('hidden');
                }
            }
        }

        if (ropcFlowEnabled) {
            ropcFlowEnabled.addEventListener('change', updateRopcFlowWarning);
            updateRopcFlowWarning(); // Initial state
        }

        // Add form submission handling
        const btnSave = document.getElementById("btnSave");
        if(btnSave) {
            btnSave.addEventListener("click", function(event) {
                event.preventDefault();

                const formSettings = document.getElementsByTagName("form")[0];
                const issuerInput = document.getElementById('issuer');

                // Check if issuer value has changed
                if (issuerInput.value !== originalIssuerValue) {
                    showModalDialog(
                        "modal1",
                        "Are you sure?",
                        "<span class='text-accent'>You are changing the issuer</span>. This will affect existing applications and tokens that depend on this value. You will also be logged out.<br /><br />Do you want to proceed and save?",
                        function() {
                            // Cancel callback - do nothing
                        },
                        function() {
                            // Confirm callback - submit the form
                            formSettings.submit();
                        }
                    );
                } else {
                    formSettings.submit();
                }
            });
        }
    });

    function refreshSelfRegistrationEmailVerification() {
        const selfRegistrationEnabled = document.getElementById('selfRegistrationEnabled');
        const selfRegistrationRequiresEmailVerification = document.getElementById('selfRegistrationRequiresEmailVerification');

        if (selfRegistrationEnabled.checked) {
            selfRegistrationRequiresEmailVerification.disabled = false;
        } else {
            selfRegistrationRequiresEmailVerification.checked = false;
            selfRegistrationRequiresEmailVerification.disabled = true;
        }
    }
</script>

{{end}}

{{define "body"}}

<form method="post">   

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">

            <div class="w-full form-control">
                <label class="label">
                    <span class="label-text text-base-content">
                        App name
                        <div class="tooltip tooltip-top"
                            data-tip="The name for this auth server. It will be displayed in certain areas of the user interface.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                </label>
                <input id="appName" type="text" name="appName" value="{{.settings.AppName}}"
                    class="w-full input input-bordered" autocomplete="off" autofocus />
            </div> 

            <div class="w-full form-control">
                <label class="label">
                    <span class="label-text text-base-content">
                        Issuer
                        <div class="tooltip tooltip-top"
                            data-tip="Used in the 'iss' claim. It identifies the auth server that issued the token. It can be a URI or a string identifier.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                </label>
                <input id="issuer" type="text" name="issuer" value="{{.settings.Issuer}}"
                    class="w-full input input-bordered" autocomplete="off" />
            </div>

        </div>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">

        <div class="w-full h-full pb-6 bg-base-100">

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        Password policy
                        <div class="tooltip tooltip-top"
                            data-tip="How strictly should the auth server evaluate passwords?">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                </label>                
                <select class="w-full select select-bordered" name="passwordPolicy">                        
                    <option value="none" {{if eq .settings.PasswordPolicy "none"}}selected{{end}}>No policy - at least 1 char</option>
                    <option value="low" {{if eq .settings.PasswordPolicy "low"}}selected{{end}}>Low strength - at least 6 chars</option>
                    <option value="medium" {{if eq .settings.PasswordPolicy "medium"}}selected{{end}}>Medium strength - at least 8 chars (must contain 1 uppercase, 1 lowercase and 1 number)</option>
                    <option value="high" {{if eq .settings.PasswordPolicy "high"}}selected{{end}}>High strength - at least 10 chars (must contain 1 uppercase, 1 lowercase, 1 number and 1 special char/symbol)</option>
                </select>                
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">User self registration enabled</span>
                        <div class="tooltip tooltip-top"
                            data-tip="If enabled, a 'register' link will be displayed on the login page. If disabled, only admins will have the ability to create users.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="selfRegistrationEnabled" type="checkbox" name="selfRegistrationEnabled"
                        class="ml-2 toggle" {{if .settings.SelfRegistrationEnabled}}checked{{end}} />
                </label>
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">User self registration requires email verification</span>
                        <div class="tooltip tooltip-top"
                            data-tip="If enabled, self-registered users will need to activate their accounts via a confirmation link sent to their email. If disabled, accounts will be created instantly without the need for email confirmation.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="selfRegistrationRequiresEmailVerification" type="checkbox" name="selfRegistrationRequiresEmailVerification"
                        class="ml-2 toggle" {{if .settings.SelfRegistrationRequiresEmailVerification}}checked{{end}} />
                </label>
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">Dynamic client registration enabled</span>
                        <div class="tooltip tooltip-top"
                            data-tip="RFC 7591 - Allow OAuth clients to self-register via the /connect/register endpoint. When enabled, the registration endpoint will be advertised in the .well-known/openid-configuration metadata. Useful for MCP (Model Context Protocol) and other dynamic integrations.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="dynamicClientRegistrationEnabled" type="checkbox" name="dynamicClientRegistrationEnabled"
                        class="ml-2 toggle" {{if .settings.DynamicClientRegistrationEnabled}}checked{{end}} />
                </label>
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">PKCE required for authorization code flow</span>
                        <div class="tooltip tooltip-top"
                            data-tip="When enabled, all clients using the authorization code flow must use PKCE (Proof Key for Code Exchange). This is a security best practice recommended by OAuth 2.1. Individual clients can override this setting.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="pkceRequired" type="checkbox" name="pkceRequired"
                        class="ml-2 toggle" {{if .settings.PKCERequired}}checked{{end}} />
                </label>
            </div>
            <div id="pkceWarning" role="alert" class="mt-2 hidden alert alert-warning alert-soft">
                <span>Warning: disabling PKCE reduces security. PKCE protects against authorization code interception attacks.
                Only disable this if you have legacy clients that cannot support PKCE.</span>
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">Implicit flow enabled</span>
                        <div class="tooltip tooltip-top"
                            data-tip="RFC 6749 Section 4.2 - Enable the OAuth 2.0 implicit grant flow. This allows clients to receive access tokens directly from the authorization endpoint. Individual clients can override this setting.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="implicitFlowEnabled" type="checkbox" name="implicitFlowEnabled"
                        class="ml-2 toggle" {{if .settings.ImplicitFlowEnabled}}checked{{end}} />
                </label>
            </div>
            <div id="implicitFlowWarning" role="alert" class="mt-2 hidden alert alert-warning alert-soft">
                <span>Warning: The implicit flow is deprecated in OAuth 2.1 and has known security vulnerabilities. Tokens are
                exposed in URLs and browser history. Use the authorization code flow with PKCE instead whenever possible.
                Only enable this for legacy clients that cannot support the authorization code flow.</span>
            </div>

            <div class="w-full mt-6 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        <span class="align-middle">Resource owner password credentials flow enabled</span>
                        <div class="tooltip tooltip-top"
                            data-tip="RFC 6749 Section 4.3 - Enable the OAuth 2.0 resource owner password credentials grant. This allows clients to exchange user credentials directly for tokens. Individual clients can override this setting.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input id="ropcFlowEnabled" type="checkbox" name="ropcFlowEnabled"
                        class="ml-2 toggle" {{if .settings.ResourceOwnerPasswordCredentialsEnabled}}checked{{end}} />
                </label>
            </div>
            <div id="ropcFlowWarning" role="alert" class="mt-2 hidden alert alert-warning alert-soft">
                <span>Warning: The resource owner password credentials flow is deprecated in OAuth 2.1 and exposes user
                credentials directly to clients. Only enable this for highly trusted first-party applications or
                legacy migration scenarios. Use the authorization code flow with PKCE whenever possible.
                Note: Users with 2FA enabled cannot use this flow.</span>
            </div>

        </div>

    </div>

    <div class="grid grid-cols-1 gap-6 mt-8 lg:grid-cols-2">
        <div>
            {{if .error}}
                <div class="mb-4 text-right text-error">
                    <p>{{.error}}</p>
                </div>
            {{end}}            
            {{ .csrfField }}
            {{if .savedSuccessfully}}
                <div class="mb-4 text-right text-success">
                    <p>&#10004; Settings saved successfully</p>
                </div>
            {{end}}
            <button id="btnSave" class="float-right btn btn-primary">Save</button>
        </div>
    </div>

</form>

{{template "modal_dialog" (args "modal1" "yes_no" ) }}
{{end}}