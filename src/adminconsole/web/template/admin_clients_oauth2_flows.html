{{define "title"}}{{ .appName }} - Client - OAuth2 flows - {{.client.ClientIdentifier}}{{end}}
{{define "pageTitle"}}Client - OAuth2 flows - <span class="text-accent">{{.client.ClientIdentifier}}</span>{{end}}
{{define "subTitle"}}{{end}}
{{define "menu"}}
    {{template "admin_menu" . }}
{{end}}

{{define "head"}}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const pkceRadios = document.querySelectorAll('input[name="pkceRequired"]');
        const pkceWarning = document.getElementById('pkceWarning');
        const authCodeEnabled = document.querySelector('input[name="authCodeEnabled"]');
        const pkceSection = document.getElementById('pkceSection');
        const globalPKCERequired = {{if .client.GlobalPKCERequired}}true{{else}}false{{end}};

        function getSelectedPkceValue() {
            for (const radio of pkceRadios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'global';
        }

        function updatePkceWarning() {
            if (!pkceWarning) return;

            const value = getSelectedPkceValue();

            // Show warning if PKCE will be optional (either explicitly or via global)
            const willBeOptional = (value === 'off') ||
                                   (value === 'global' && !globalPKCERequired);

            if (willBeOptional) {
                pkceWarning.classList.remove('hidden');
            } else {
                pkceWarning.classList.add('hidden');
            }
        }

        function updatePkceSectionVisibility() {
            if (!pkceSection || !authCodeEnabled) return;

            if (authCodeEnabled.checked) {
                pkceSection.classList.remove('hidden');
                updatePkceWarning(); // Also update warning visibility
            } else {
                pkceSection.classList.add('hidden');
                pkceWarning.classList.add('hidden'); // Hide warning when section is hidden
            }
        }

        // Add listeners to all PKCE radio buttons
        pkceRadios.forEach(function(radio) {
            radio.addEventListener('change', updatePkceWarning);
        });

        if (authCodeEnabled) {
            authCodeEnabled.addEventListener('change', updatePkceSectionVisibility);
        }

        // Initial state
        updatePkceSectionVisibility();

        // Implicit flow warning handling
        const implicitRadios = document.querySelectorAll('input[name="implicitGrantEnabled"]');
        const implicitWarning = document.getElementById('implicitWarning');
        const globalImplicitFlowEnabled = {{if .client.GlobalImplicitFlowEnabled}}true{{else}}false{{end}};

        function getSelectedImplicitValue() {
            for (const radio of implicitRadios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'global';
        }

        function updateImplicitWarning() {
            if (!implicitWarning) return;

            const value = getSelectedImplicitValue();

            // Show warning if implicit flow will be enabled (either explicitly or via global)
            const willBeEnabled = (value === 'on') ||
                                  (value === 'global' && globalImplicitFlowEnabled);

            if (willBeEnabled) {
                implicitWarning.classList.remove('hidden');
            } else {
                implicitWarning.classList.add('hidden');
            }
        }

        // Add listeners to all implicit flow radio buttons
        implicitRadios.forEach(function(radio) {
            radio.addEventListener('change', updateImplicitWarning);
        });

        // Initial state
        updateImplicitWarning();
    });
</script>

{{end}}

{{define "body"}}

{{template "manage_clients_tabs" (args "oauth2-flows" .client.ClientId) }}

<form method="post">

    {{if .client.IsSystemLevelClient}}
    <div class="grid grid-cols-1 gap-6 mt-6 lg:grid-cols-2">        
        <div class="mt-2 w-fit form-control">
            <p class="px-2 ml-1 rounded text-warning-content bg-warning">The settings for this system-level client cannot be changed.</p>
        </div>        
    </div>
    {{end}}

    <div class="grid grid-cols-1 gap-6 mt-6 lg:grid-cols-2">

        <div class="w-full h-full pb-6 bg-base-100">          

            <div class="w-full form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        Authorization code with PKCE
                        <div class="tooltip tooltip-top"
                            data-tip="The Authorization Code flow is commonly used for user authentication and authorization in various applications, including web and mobile applications.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input type="checkbox" name="authCodeEnabled" class="ml-2 toggle" 
                        {{if .client.AuthorizationCodeEnabled}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                </label>
            </div>

            <div id="pkceSection" class="w-full mt-6 form-control {{if not .client.AuthorizationCodeEnabled}}hidden{{end}}">
                <p class="mb-4 font-medium">PKCE requirement for this client?</p>
                <div class="ml-1 space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="pkceRequired" class="radio radio-sm" value="on"
                            {{if and .client.PKCERequired (deref .client.PKCERequired)}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Required</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="pkceRequired" class="radio radio-sm" value="off"
                            {{if and .client.PKCERequired (not (deref .client.PKCERequired))}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Optional (not recommended)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="pkceRequired" class="radio radio-sm" value="global"
                            {{if not .client.PKCERequired}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Inherit from <a href="/admin/settings/general"
                            class="link link-hover link-secondary">global setting</a> (currently: {{if .client.GlobalPKCERequired}}required{{else}}optional{{end}})</span>
                    </label>
                </div>
            </div>

            <div id="pkceWarning" role="alert" class="hidden mt-2 alert alert-warning alert-soft">
                {{if .client.IsPublic}}
                <span>Warning: disabling PKCE for public clients significantly reduces security.
                Public clients cannot securely store secrets, making PKCE essential for protection against
                authorization code interception attacks.</span>
                {{else}}
                <span>Warning: disabling PKCE reduces security. PKCE protects against authorization code
                interception attacks. Only disable this if you have legacy clients that cannot support PKCE.</span>
                {{end}}
            </div>

            <div class="w-full mt-10 form-control">
                <label class="cursor-pointer label">
                    <span class="label-text">
                        Client credentials
                        <div class="tooltip tooltip-top"
                            data-tip="The client credentials flow is commonly employed for server-to-server communication. For instance, a backend service may use this flow to establish its identity with an API server in order to retrieve data.">
                            <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                        </div>
                    </span>
                    <input type="checkbox" name="clientCredentialsEnabled" class="ml-2 toggle"
                        {{if .client.ClientCredentialsEnabled}}checked{{end}} {{if or .client.IsPublic .client.IsSystemLevelClient}}disabled{{end}} />
                </label>
                {{if .client.IsPublic}}
                    <p class="mt-1">Your client authentication must be configured as <span class="text-accent">confidential</span> for you to activate the client credentials flow.</p>
                {{end}}
            </div>

            <div class="w-full mt-10 form-control">
                <span class="mb-4 font-medium">
                    Implicit flow
                    <span class="tooltip tooltip-top"
                        data-tip="RFC 6749 Section 4.2 - The implicit flow returns tokens directly from the authorization endpoint. This flow is deprecated in OAuth 2.1 due to security concerns.">
                        <svg class="inline-block w-6 h-6 ml-1 align-middle cursor-pointer"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                    </span>
                </span>
                <div class="ml-1 space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="implicitGrantEnabled" class="radio radio-sm" value="on"
                            {{if and .client.ImplicitGrantEnabled (deref .client.ImplicitGrantEnabled)}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Enabled</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="implicitGrantEnabled" class="radio radio-sm" value="off"
                            {{if and .client.ImplicitGrantEnabled (not (deref .client.ImplicitGrantEnabled))}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Disabled</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="implicitGrantEnabled" class="radio radio-sm" value="global"
                            {{if not .client.ImplicitGrantEnabled}}checked{{end}} {{if .client.IsSystemLevelClient}}disabled{{end}} />
                        <span class="label-text">Inherit from <a href="/admin/settings/general"
                            class="link link-hover link-secondary">global setting</a> (currently: {{if .client.GlobalImplicitFlowEnabled}}enabled{{else}}disabled{{end}})</span>
                    </label>
                </div>
            </div>

            <div id="implicitWarning" role="alert" class="hidden mt-2 alert alert-warning alert-soft">
                <span>Warning: The implicit flow is deprecated in OAuth 2.1 and has known security vulnerabilities.
                Tokens are exposed in URLs and browser history, and no refresh tokens can be issued.
                Use the authorization code flow with PKCE instead whenever possible.</span>
            </div>
        </div>

    </div>

    <div class="grid grid-cols-1 gap-6 mt-8 lg:grid-cols-2">
        <div>
            {{if .error}}
                <div class="mb-4 text-right text-error">
                    <p>{{.error}}</p>
                </div>
            {{end}}
            <div class="float-left p-3">
                <a class="link-secondary" href="/admin/clients">
                    <svg class="inline-block w-6 h-6 align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                    <span class="ml-1 align-middle">Back to list of clients</span>
                </a>
            </div>
            {{ .csrfField }}
            {{if .savedSuccessfully}}
                <div class="mb-4 text-right text-success">
                    <p>&#10004; Client OAuth2 flows saved successfully</p>
                </div>
            {{end}}
            {{if not .client.IsSystemLevelClient}}
                <button id="btnSave" class="float-right btn btn-primary">Save</button>
            {{end}}
        </div>
    </div>

</form>

{{end}}