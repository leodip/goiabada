{{define "title"}}{{ .appName }} - Client permissions - {{.client.ClientIdentifier}}{{end}}
{{define "pageTitle"}}Client permissions - <span class="text-accent">{{.client.ClientIdentifier}}</span>{{end}}
{{define "subTitle"}}{{end}}
{{define "menu"}}
    {{template "admin_menu" . }}
{{end}}

{{define "head"}}

<script>
   {{- $len := len .client.Permissions}}
   {{- $idx := 0}}
   var assignedPermissions = {
      {{- range $key, $value := .client.Permissions}}      
      {{$key}}: {
         "Scope": "{{$value}}"
       }{{- if not (isLast $idx $len)}},{{- end}}
       {{- $idx = add $idx 1}}
      {{- end}}
   };

   document.addEventListener("DOMContentLoaded", function () {
        refreshPermissionsTable();

        const resourcesSelect = document.getElementById('resourcesSelect');
        if (resourcesSelect) {
            resourcesSelect.addEventListener('change', function () {
                resourceChanged();
            });
            resourceChanged();
        }

        const btnSave = document.getElementById("btnSave");
        if (btnSave) {
            btnSave.addEventListener("click", function (evt) {
                btnSaveClick(evt);
            });
        }
    });

   function btnSaveClick(evt) {
        evt.preventDefault();

        var isSystemLevel = {{if .client.IsSystemLevelClient}}true{{else}}false{{end}};

        function doSave() {
            const loadingIcon = document.getElementById("loadingIcon");

            let assignedPermissionsIds = [];
            for (const [key, value] of Object.entries(assignedPermissions)) {
                assignedPermissionsIds.push(parseInt(key, 10));
            }

            sendAjaxRequest({
                "url": "/admin/clients/{{.client.ClientId}}/permissions",
                "method": "POST",
                "bodyData": JSON.stringify({
                    "clientId": {{.client.ClientId }},
                    "assignedPermissionsIds": assignedPermissionsIds
                }),
                "loadingElement": loadingIcon,
                "loadingClasses": ["loading", "loading-xs"],
                "modalId": "modal0",
                "callback": function(result) {

                        if (result.Success) {
                            window.location.href = "/admin/clients/{{.client.ClientId}}/permissions";
                        } else {
                            showModalDialog("modal0", "Error", "An unexpected error has occurred.");
                        }
                    }
            });
        }

        if (isSystemLevel) {
            showModalDialog("modal1", "Are you sure?",
                "You are about to modify a <span class='text-accent'>system-level client</span>. " +
                "Incorrect changes could break Goiabada's authentication or admin console." +
                "<br /><br />Are you sure you want to save?",
                function() { /* cancel */ },
                function() { doSave(); }
            );
        } else {
            doSave();
        }
   }

   function resourceChanged() {
        const resourcesSelect = document.getElementById('resourcesSelect');
        const permissionsSelect = document.getElementById('permissionsSelect');

        const resource = resourcesSelect.value;
        if (resource.length == 0) {
            permissionsSelect.value = "";
            permissionsSelect.disabled = true;
        } else {
            permissionsSelect.disabled = false;

            sendAjaxRequest({
                "url": "/admin/get-permissions?" + new URLSearchParams({
                    resourceId: resource,
                }),
                "method": "GET",
                "bodyData": null,
                "loadingElement": null,
                "loadingClasses": null,
                "modalId": "modal0",
                "callback": function (result) {

                    if (result.Permissions.length == 0) {
                        permissionsSelect.value = "";
                        permissionsSelect.disabled = true;
                    } else {
                        permissionsSelect.innerHTML = "";
                        permissionsSelect.options[permissionsSelect.options.length] = new Option("Select a permission...", "");
                        result.Permissions.forEach((permission) => {
                            let name = permission.PermissionIdentifier;
                            if (permission.Description.length > 0) {
                                name += " (" + permission.Description + ")";
                            }
                            opt = new Option(name, permission.Id);
                            opt.setAttribute('data-permissionidentifier', permission.PermissionIdentifier);
                            permissionsSelect.options[permissionsSelect.options.length] = opt;
                        });
                    }
                }
            });

        }
    }

   function grantPermission(evt, elem) {
        evt.preventDefault();

        const permissionsTable = document.getElementById("permissionsTable");
        const resourcesSelect = document.getElementById("resourcesSelect");
        const permissionsSelect = document.getElementById("permissionsSelect");

        const permission = permissionsSelect.value;
        if (permission.length == 0) {
            showModalDialog("modal0", "Error", "Please select a permission.");
            return;
        } else {
            if (assignedPermissions[permission] !== undefined) {
                showModalDialog("modal0", "Error", "The permission is already in the list.");
                return;
            }

            scope = resourcesSelect.options[resourcesSelect.selectedIndex].dataset.resourceidentifier + ":" +
                permissionsSelect.options[permissionsSelect.selectedIndex].dataset.permissionidentifier;

            assignedPermissions[permission] = {
                Id: permission,
                Scope: scope
            };
            refreshPermissionsTable();
            permissionsSelect.value = "";
        }
    }

   function refreshPermissionsTable() {
        const permissionsTable = document.getElementById("permissionsTable");

        if (permissionsTable) {
            const tbody = permissionsTable.getElementsByTagName("tbody")[0];
            tbody.innerHTML = "";

            if (Object.keys(assignedPermissions).length == 0) {
                const row = tbody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                cell1.className = "p-1 font-mono text-sm align-middle";
                cell1.innerHTML = "(none yet)"

                cell2.className = "p-1 text-right";
                cell2.innerHTML = "&nbsp;";
            } else {
                for (const [key, value] of Object.entries(assignedPermissions)) {
                    const row = tbody.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    cell1.className = "p-1 font-mono text-sm align-middle";
                    cell1.innerHTML = value.Scope;

                    cell2.className = "p-1 text-right";
                    cell2.innerHTML = getTrashCanMarkup("", "deletePermission(event, this);", "data-permissionid='" + parseInt(key, 10) + "'");
                }
            }
        }
    }

   function deletePermission(evt, elem) {
        evt.preventDefault();

        const permissionId = elem.dataset.permissionid;
        delete assignedPermissions[permissionId];
        refreshPermissionsTable();
    }
</script>

{{end}}

{{define "body"}}

{{template "manage_clients_tabs" (args "permissions" .client.ClientId) }}

<form method="post">

    {{if .client.IsSystemLevelClient}}
    <div class="grid grid-cols-1 gap-6 mt-6 lg:grid-cols-2">
        <div role="alert" class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none"
                viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <span>This is a system-level client. Modifying it incorrectly could affect Goiabada's core functionality. Proceed with caution.</span>
        </div>
    </div>
    {{end}}

   <div class="grid grid-cols-1 gap-6 mt-6 lg:grid-cols-2">

      <div class="w-full h-full pb-6 bg-base-100">

         {{if .client.ClientCredentialsEnabled}}
         <div id="clientPermissionsEnabledPanel">

            <div class="w-full form-control">
               <label class="label">
                     <span class="label-text text-base-content">Resource</span>
               </label>
               <select id="resourcesSelect" class="w-full select select-bordered" name="resource">
                     <option value="">Select a resource...</option>
                     {{range $key, $value := .resources}}
                        {{if $value.Description}}
                           <option value="{{$value.Id}}" data-resourceidentifier="{{$value.ResourceIdentifier}}">{{$value.ResourceIdentifier}} ({{$value.Description}})</option>
                        {{else}}
                           <option value="{{$value.Id}}" data-resourceidentifier="{{$value.ResourceIdentifier}}">{{$value.ResourceIdentifier}}</option>
                        {{end}}
                     {{end}}
               </select>
            </div>

            <div class="w-full mt-6 form-control">
               <label class="label">
                     <span class="label-text text-base-content">Permission</span>
               </label>
               <select id="permissionsSelect" class="w-full select select-bordered" name="resource" disabled>
                     <option value="">Select a permission...</option>
               </select>                   
            </div>

            <div class="flex w-full mt-6 form-control">
               <button onclick="grantPermission(event, this);" class="ml-auto w-fit btn btn-secondary btn-sm">Grant permission</button>
            </div>

            <div class="w-full mt-6">
               <table id="permissionsTable" class="table">
                     <thead>
                        <tr>
                            <th class="p-1 text-lg">Granted resource:permission</th>
                            <th></th>
                        </tr>
                     </thead>
                     <tbody>
                     </tbody>
               </table>
            </div>

         </div>
         {{end}}

         {{if not .client.ClientCredentialsEnabled}}
         <div id="clientPermissionsDisabledPanel">
            <p>Client permissions can only be configured within the context of the <span class='text-accent'>client credentials flow</span>.</p>
         </div>
         {{end}}

      </div>

   </div>

   <div class="grid grid-cols-1 gap-6 mt-8 lg:grid-cols-2">
      <div>
          {{if .error}}
              <div class="mb-4 text-right text-error">
                  <p>{{.error}}</p>
              </div>
          {{end}}

          <div class="float-left p-3">
                <a class="link-secondary" href="/admin/clients">
                    <svg class="inline-block w-6 h-6 align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                    <span class="ml-1 align-middle">Back to list of clients</span>
                </a>
          </div>
          {{ .csrfField }}
          {{if .savedSuccessfully}}
              <div class="mb-4 text-right text-success">
                  <p>&#10004; Client permissions saved successfully</p>
              </div>
          {{end}}
          {{if .client.ClientCredentialsEnabled}}
                <span id="loadingIcon" class="hidden w-5 h-5 mr-2 align-middle text-primary float-right">&nbsp;</span>
                <button id="btnSave" class="float-right btn btn-primary">Save</button>
          {{end}}

        </div>      
            
    </div>

</form>

{{template "modal_dialog" (args "modal0" "close" ) }}

{{template "modal_dialog" (args "modal1" "yes_no" ) }}

{{end}}